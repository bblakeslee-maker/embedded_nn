/*
 * Academic License - for use in teaching, academic research, and meeting
 * course requirements at degree granting institutions only.  Not for
 * government, commercial, or other organizational use.
 * File: lenetSynthMatlab_fixpt.c
 *
 * MATLAB Coder version            : 4.0
 * C/C++ source code generated on  : 10-Dec-2018 14:59:12
 */

/* Include Files */
#include <string.h>
#include "lenetSynthMatlab_fixpt.h"
#include "mtimes.h"
#include "max.h"
#include "sum.h"
#include "lenetSynthMatlab_fixpt_data.h"

/* Function Definitions */

/*
 * function [netScores] = lenetSynthMatlab_fixpt(inputImg)
 * LENETSYNTH Synthesizable model of LeNet5
 *    inputImg: 32x32x1 MNIST image
 * Arguments    : const unsigned char inputImg[1024]
 *                short netScores[10]
 * Return Type  : void
 */
void lenetSynthMatlab_fixpt(const unsigned char inputImg[1024], short netScores
  [10])
{
  int f;
  short conv1ActivationMap[4704];
  short iv10[4704];
  int i0;
  int r;
  unsigned short relu1ActivationMap[4704];
  int c;
  unsigned short pool1ActivationMap[1176];
  unsigned char rowOutIdx;
  int iv11[25];
  int iv12[5];
  int i1;
  long i2;
  long i3;
  unsigned char imgRegion[25];
  int i;
  long i4;
  short conv2ActivationMap[1600];
  short iv13[1600];
  unsigned char colOutIdx;
  long i5;
  unsigned short relu2ActivationMap[1600];
  int b_c;
  unsigned short pool2ActivationMap[400];
  long i6;
  unsigned short b_relu1ActivationMap[4];
  unsigned short x0[2];
  unsigned short maxval;
  int iv14[150];
  long iv15[30];
  long iv16[6];
  unsigned short b_imgRegion[150];
  long i7;
  int b_pool2ActivationMap[400];
  long iv17[80];
  long iv18[16];
  long i8;
  short fc1ActivationMap[120];
  short iv19[120];
  long i9;
  long i10;
  unsigned short uv0[120];
  long iv20[84];
  long i11;
  short iv21[84];
  long iv22[10];
  long i12;
  long i13;
  long i14;
  long i15;
  long i16;
  long i17;
  long i18;

  /* %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% */
  /*                                                                           % */
  /*            Generated by MATLAB 9.4 and Fixed-Point Designer 6.1           % */
  /*                                                                           % */
  /* %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% */
  /*  Load all constants */
  /*  networkWeights = coder.load('networkWeights.mat'); */
  /* 'lenetSynthMatlab_fixpt:13' fm = get_fimath(); */
  /* 'lenetSynthMatlab_fixpt:15' weightsConv1_g = fi(weightsConv1_g, 1, 16, 16, fm); */
  /* 'lenetSynthMatlab_fixpt:16' biasConv1_g = fi(biasConv1_g, 1, 16, 27, fm); */
  /* 'lenetSynthMatlab_fixpt:17' weightsConv2_g = fi(weightsConv2_g, 1, 16, 17, fm); */
  /* 'lenetSynthMatlab_fixpt:18' biasConv2_g = fi(biasConv2_g, 1, 16, 25, fm); */
  /* 'lenetSynthMatlab_fixpt:19' weightsFC1_g = fi(weightsFC1_g, 1, 16, 18, fm); */
  /* 'lenetSynthMatlab_fixpt:20' biasFC1_g = fi(biasFC1_g, 1, 16, 25, fm); */
  /* 'lenetSynthMatlab_fixpt:21' weightsFC2_g = fi(weightsFC2_g, 1, 16, 18, fm); */
  /* 'lenetSynthMatlab_fixpt:22' biasFC2_g = fi(biasFC2_g, 1, 16, 23, fm); */
  /* 'lenetSynthMatlab_fixpt:23' weightsFC3_g = fi(weightsFC3_g, 1, 16, 17, fm); */
  /* 'lenetSynthMatlab_fixpt:24' biasFC3_g = fi(biasFC3_g, 1, 16, 18, fm); */
  /*  Layer 1: conv1 -- OK */
  /* 'lenetSynthMatlab_fixpt:27' conv1ActivationMap = fi(zeros(28, 28, 6), 1, 16, 5, fm); */
  /* 'lenetSynthMatlab_fixpt:28' for f = 1:1:6 */
  for (f = 0; f < 6; f++) {
    /*  Extract desired filter */
    /* 'lenetSynthMatlab_fixpt:30' filter = fi(weightsConv1_g(:, : , :, f), 1, 16, 16, fm); */
    /* 'lenetSynthMatlab_fixpt:31' for r = 1:1:28 */
    for (r = 0; r < 28; r++) {
      /* 'lenetSynthMatlab_fixpt:32' for c = 1:1:28 */
      for (c = 0; c < 28; c++) {
        /* 'lenetSynthMatlab_fixpt:33' imgRegion = fi(inputImg(r:r + 4, c:c + 4, :), 0, 8, 0, fm); */
        /* 'lenetSynthMatlab_fixpt:34' conv1ActivationMap(r, c, f) = sum(sum(filter .* imgRegion)) + biasConv1_g(:, :, f); */
        for (i0 = 0; i0 < 5; i0++) {
          for (i1 = 0; i1 < 5; i1++) {
            imgRegion[i1 + 5 * i0] = inputImg[(i1 + c) + ((i0 + r) << 5)];
            i = weightsConv1_g[(f + 6 * i1) + 30 * i0] * imgRegion[i1 + 5 * i0];
            if ((i & 8388608) != 0) {
              iv11[i1 + 5 * i0] = i | -8388608;
            } else {
              iv11[i1 + 5 * i0] = i & 8388607;
            }
          }
        }

        sum(iv11, iv12);
        i2 = (long)b_sum(iv12) << 11;
        i3 = biasConv1_g[f];
        if ((i2 & 2199023255552L) != 0L) {
          i4 = i2 | -2199023255552L;
        } else {
          i4 = i2 & 2199023255551L;
        }

        if ((i3 & 2199023255552L) != 0L) {
          i5 = i3 | -2199023255552L;
        } else {
          i5 = i3 & 2199023255551L;
        }

        i2 = i4 + i5;
        if ((i2 & 2199023255552L) != 0L) {
          i6 = i2 | -2199023255552L;
        } else {
          i6 = i2 & 2199023255551L;
        }

        conv1ActivationMap[(f + 6 * c) + 168 * r] = (short)(i6 >> 22);
      }
    }
  }

  /*  Layer 2: relu1 -- OK */
  /* 'lenetSynthMatlab_fixpt:40' relu1ActivationMap = fi(max(fi(0, 0, 1, 0, fm), conv1ActivationMap), 0, 16, 6, fm); */
  b_max(conv1ActivationMap, iv10);
  for (i0 = 0; i0 < 4704; i0++) {
    relu1ActivationMap[i0] = (unsigned short)((unsigned short)iv10[i0] << 1);
  }

  /*  Layer 3: pool1 -- OK */
  /* 'lenetSynthMatlab_fixpt:43' pool1ActivationMap = fi(zeros(14, 14, 6), 0, 16, 6, fm); */
  memset(&pool1ActivationMap[0], 0, 1176U * sizeof(unsigned short));

  /* 'lenetSynthMatlab_fixpt:44' for f = 1:1:6 */
  for (f = 0; f < 6; f++) {
    /* 'lenetSynthMatlab_fixpt:45' rowOutIdx = fi(1, 0, 4, 0, fm); */
    rowOutIdx = 1U;

    /* 'lenetSynthMatlab_fixpt:46' for r = 1:2:27 */
    for (r = 0; r < 14; r++) {
      i = r << 1;

      /* 'lenetSynthMatlab_fixpt:47' colOutIdx = fi(1, 0, 4, 0, fm); */
      colOutIdx = 1U;

      /* 'lenetSynthMatlab_fixpt:48' for c = 1:2:27 */
      for (c = 0; c < 14; c++) {
        b_c = c << 1;

        /* 'lenetSynthMatlab_fixpt:49' pool1ActivationMap(rowOutIdx, colOutIdx, f) = max(max(relu1ActivationMap(r:r + 1, c:c + 1, f))); */
        for (i0 = 0; i0 < 2; i0++) {
          for (i1 = 0; i1 < 2; i1++) {
            b_relu1ActivationMap[i1 + (i0 << 1)] = relu1ActivationMap[(f + 6 *
              (i1 + b_c)) + 168 * (i0 + i)];
          }
        }

        c_max(b_relu1ActivationMap, x0);
        maxval = x0[0];
        if (x0[0] < x0[1]) {
          maxval = x0[1];
        }

        pool1ActivationMap[(f + 6 * (colOutIdx - 1)) + 84 * (rowOutIdx - 1)] =
          maxval;

        /* 'lenetSynthMatlab_fixpt:50' colOutIdx(:) = colOutIdx + fi(1, 0, 1, 0, fm); */
        colOutIdx = (unsigned char)((int)(colOutIdx + 1U) & 15);
      }

      /* 'lenetSynthMatlab_fixpt:52' rowOutIdx(:) = rowOutIdx + fi(1, 0, 1, 0, fm); */
      rowOutIdx = (unsigned char)((int)(rowOutIdx + 1U) & 15);
    }
  }

  /*  Layer 4: conv2 -- OK */
  /* 'lenetSynthMatlab_fixpt:57' conv2ActivationMap = fi(zeros(10, 10, 16), 1, 16, 5, fm); */
  /* 'lenetSynthMatlab_fixpt:58' for f = 1:1:16 */
  for (f = 0; f < 16; f++) {
    /*  Extract desired filter */
    /* 'lenetSynthMatlab_fixpt:60' filter = fi(weightsConv2_g(:, : , :, f), 1, 16, 17, fm); */
    /* 'lenetSynthMatlab_fixpt:61' for r = 1:1:10 */
    for (r = 0; r < 10; r++) {
      /* 'lenetSynthMatlab_fixpt:62' for c = 1:1:10 */
      for (c = 0; c < 10; c++) {
        /* 'lenetSynthMatlab_fixpt:63' imgRegion = fi(pool1ActivationMap(r:r + 4, c:c + 4, :), 0, 16, 6, fm); */
        /* 'lenetSynthMatlab_fixpt:64' conv2ActivationMap(r, c, f) = sum(sum(sum(filter .* imgRegion))) + biasConv2_g(:, :, f); */
        for (i0 = 0; i0 < 5; i0++) {
          for (i1 = 0; i1 < 5; i1++) {
            for (i = 0; i < 6; i++) {
              b_imgRegion[(i + 6 * i1) + 30 * i0] = pool1ActivationMap[(i + 6 *
                (i1 + c)) + 84 * (i0 + r)];
              iv14[(i + 6 * i1) + 30 * i0] = weightsConv2_g[((f + (i << 4)) + 96
                * i1) + 480 * i0] * b_imgRegion[(i + 6 * i1) + 30 * i0];
            }
          }
        }

        c_sum(iv14, iv15);
        d_sum(iv15, iv16);
        i2 = e_sum(iv16) << 2;
        i3 = biasConv2_g[f];
        if ((i2 & 8796093022208L) != 0L) {
          i7 = i2 | -8796093022208L;
        } else {
          i7 = i2 & 8796093022207L;
        }

        if ((i3 & 8796093022208L) != 0L) {
          i8 = i3 | -8796093022208L;
        } else {
          i8 = i3 & 8796093022207L;
        }

        i2 = i7 + i8;
        if ((i2 & 8796093022208L) != 0L) {
          i10 = i2 | -8796093022208L;
        } else {
          i10 = i2 & 8796093022207L;
        }

        conv2ActivationMap[(f + (c << 4)) + 160 * r] = (short)(i10 >> 20);
      }
    }
  }

  /*  Layer 5: relu2 -- OK */
  /* 'lenetSynthMatlab_fixpt:70' relu2ActivationMap = fi(max(fi(0, 0, 1, 0, fm), conv2ActivationMap), 0, 16, 7, fm); */
  d_max(conv2ActivationMap, iv13);
  for (i0 = 0; i0 < 1600; i0++) {
    relu2ActivationMap[i0] = (unsigned short)((unsigned short)iv13[i0] << 2);
  }

  /*  Layer 6: pool2 -- OK */
  /* 'lenetSynthMatlab_fixpt:73' pool2ActivationMap = fi(zeros(5, 5, 16), 0, 16, 7, fm); */
  memset(&pool2ActivationMap[0], 0, 400U * sizeof(unsigned short));

  /* 'lenetSynthMatlab_fixpt:74' for f = 1:1:16 */
  for (f = 0; f < 16; f++) {
    /* 'lenetSynthMatlab_fixpt:75' rowOutIdx = fi(1, 0, 4, 0, fm); */
    rowOutIdx = 1U;

    /* 'lenetSynthMatlab_fixpt:76' for r = 1:2:9 */
    for (r = 0; r < 5; r++) {
      i = r << 1;

      /* 'lenetSynthMatlab_fixpt:77' colOutIdx = fi(1, 0, 4, 0, fm); */
      colOutIdx = 1U;

      /* 'lenetSynthMatlab_fixpt:78' for c = 1:2:9 */
      for (c = 0; c < 5; c++) {
        b_c = c << 1;

        /* 'lenetSynthMatlab_fixpt:79' pool2ActivationMap(rowOutIdx, colOutIdx, f) = max(max(relu2ActivationMap(r:r + 1, c:c + 1, f))); */
        for (i0 = 0; i0 < 2; i0++) {
          for (i1 = 0; i1 < 2; i1++) {
            b_relu1ActivationMap[i1 + (i0 << 1)] = relu2ActivationMap[(f + ((i1
              + b_c) << 4)) + 160 * (i0 + i)];
          }
        }

        e_max(b_relu1ActivationMap, x0);
        maxval = x0[0];
        if (x0[0] < x0[1]) {
          maxval = x0[1];
        }

        pool2ActivationMap[(f + ((colOutIdx - 1) << 4)) + 80 * (rowOutIdx - 1)] =
          maxval;

        /* 'lenetSynthMatlab_fixpt:80' colOutIdx(:) = colOutIdx + fi(1, 0, 1, 0, fm); */
        colOutIdx = (unsigned char)((int)(colOutIdx + 1U) & 15);
      }

      /* 'lenetSynthMatlab_fixpt:82' rowOutIdx(:) = rowOutIdx + fi(1, 0, 1, 0, fm); */
      rowOutIdx = (unsigned char)((int)(rowOutIdx + 1U) & 15);
    }
  }

  /*  Layer 7: fc1 -- OK */
  /* 'lenetSynthMatlab_fixpt:87' fc1ActivationMap = fi(zeros(120, 1), 1, 16, 6, fm); */
  /* 'lenetSynthMatlab_fixpt:88' for f = 1:1:120 */
  for (f = 0; f < 120; f++) {
    /* 'lenetSynthMatlab_fixpt:89' fc1ActivationMap(f) = sum(sum(sum((pool2ActivationMap .* weightsFC1_g(:, :, :, f))))) + biasFC1_g(:, :, f); */
    for (i0 = 0; i0 < 5; i0++) {
      for (i1 = 0; i1 < 5; i1++) {
        for (i = 0; i < 16; i++) {
          b_pool2ActivationMap[(i + (i1 << 4)) + 80 * i0] = pool2ActivationMap
            [(i + (i1 << 4)) + 80 * i0] * weightsFC1_g[((f + 120 * i) + 1920 *
            i1) + 9600 * i0];
        }
      }
    }

    f_sum(b_pool2ActivationMap, iv17);
    g_sum(iv17, iv18);
    i2 = h_sum(iv18);
    i3 = biasFC1_g[f];
    if ((i2 & 4398046511104L) != 0L) {
      i9 = i2 | -4398046511104L;
    } else {
      i9 = i2 & 4398046511103L;
    }

    if ((i3 & 4398046511104L) != 0L) {
      i11 = i3 | -4398046511104L;
    } else {
      i11 = i3 & 4398046511103L;
    }

    i2 = i9 + i11;
    if ((i2 & 4398046511104L) != 0L) {
      i13 = i2 | -4398046511104L;
    } else {
      i13 = i2 & 4398046511103L;
    }

    fc1ActivationMap[f] = (short)(i13 >> 19);
  }

  /*  Layer 8: relu3 -- OK */
  /* 'lenetSynthMatlab_fixpt:93' relu3ActivationMap = fi(max(fi(0, 0, 1, 0, fm), fc1ActivationMap), 0, 16, 8, fm); */
  /*  Layer 9: fc2 -- OK */
  /* 'lenetSynthMatlab_fixpt:96' fc2ActivationMap = fi(weightsFC2_g * relu3ActivationMap + biasFC2_g, 1, 16, 9, fm); */
  /*  Layer 10: fc3 -- OK */
  /* 'lenetSynthMatlab_fixpt:99' netScores = fi(weightsFC3_g * fc2ActivationMap + biasFC3_g, 1, 16, 9, fm); */
  f_max(fc1ActivationMap, iv19);
  for (i = 0; i < 120; i++) {
    uv0[i] = (unsigned short)((unsigned short)iv19[i] << 2);
  }

  mtimes(weightsFC2_g, uv0, iv20);
  for (i = 0; i < 84; i++) {
    i2 = iv20[i];
    i3 = (long)biasFC2_g[i] << 3;
    if ((i2 & 549755813888L) != 0L) {
      i12 = i2 | -549755813888L;
    } else {
      i12 = i2 & 549755813887L;
    }

    if ((i3 & 549755813888L) != 0L) {
      i15 = i3 | -549755813888L;
    } else {
      i15 = i3 & 549755813887L;
    }

    i2 = i12 + i15;
    if ((i2 & 549755813888L) != 0L) {
      i17 = i2 | -549755813888L;
    } else {
      i17 = i2 & 549755813887L;
    }

    iv21[i] = (short)(i17 >> 17);
  }

  b_mtimes(weightsFC3_g, iv21, iv22);
  for (i = 0; i < 10; i++) {
    i2 = iv22[i];
    i3 = (long)biasFC3_g[i] << 8;
    if ((i2 & 549755813888L) != 0L) {
      i14 = i2 | -549755813888L;
    } else {
      i14 = i2 & 549755813887L;
    }

    if ((i3 & 549755813888L) != 0L) {
      i16 = i3 | -549755813888L;
    } else {
      i16 = i3 & 549755813887L;
    }

    i2 = i14 + i16;
    if ((i2 & 549755813888L) != 0L) {
      i18 = i2 | -549755813888L;
    } else {
      i18 = i2 & 549755813887L;
    }

    netScores[i] = (short)(i18 >> 17);
  }
}

/*
 * File trailer for lenetSynthMatlab_fixpt.c
 *
 * [EOF]
 */
